<script>
/* Elements */
const overlay = document.getElementById('overlay');
const cakeWrap = document.getElementById('cakeWrap');
const flame = document.getElementById('flame');
const stage = document.getElementById('stage');
const song = document.getElementById('song');
const floatWrap = document.getElementById('floatWrap');
const giftBox = document.getElementById('giftBox');
const photoFrame = document.getElementById('photoFrame');
const typingWrap = document.getElementById('typingWrap');
const scrollArrow = document.getElementById('scrollArrow');
const yenaVideo = document.getElementById('yenaVideo');

let lit = true;

/* Blow out overlay with flame disappears instantly */
cakeWrap.addEventListener('click', blowOut);
cakeWrap.addEventListener('keydown', (e) => { if(e.code==='Enter'||e.code==='Space') blowOut(); });

function blowOut() {
  if (!lit) return;
  lit = false;
  // remove flame immediately
  flame.remove();

  // create smoke slightly after
  setTimeout(() => {
    for(let i=0;i<3;i++){
      const s = document.createElement('div');
      s.className='smoke';
      s.style.animationDelay = `${i*0.28}s`;
      cakeWrap.appendChild(s);
      s.addEventListener('animationend', ()=>s.remove());
    }
  },220);

  // remove overlay and show stage
  setTimeout(() => {
    overlay.style.display='none';
    stage.style.display='block';
    startFloating();
    startGlitter();
    // play birthday song
    song.play().catch(()=>{});
    // video will only play on scroll arrow click
  }, 200);
}

/* Floating icons */
const icons = ['🎈','💖','⭐','🎀','✨'];
function spawnIcon(){ const el=document.createElement('i'); el.textContent=icons[Math.floor(Math.random()*icons.length)]; el.style.left=Math.random()*90+'%'; el.style.animationDuration=(6+Math.random()*8)+'s'; floatWrap.appendChild(el); el.addEventListener('animationend',()=>el.remove()); }
function startFloating(){ for(let i=0;i<10;i++) spawnIcon(); setInterval(spawnIcon,900); }
function startGlitter(){ for(let i=0;i<60;i++){ const g=document.createElement('div'); g.className='glitter'; g.style.left=Math.random()*100+'%'; g.style.top=Math.random()*100+'%'; g.style.animationDelay=Math.random()*3+'s'; stage.appendChild(g); } }

/* Gift reveal */
giftBox.addEventListener('click', openGift);
giftBox.addEventListener('keydown', (e)=>{ if(e.code==='Enter'||e.code==='Space') openGift(); });

function openGift(){
  if(giftBox.classList.contains('open')) return;
  giftBox.classList.add('open');
  setTimeout(()=>{
    giftBox.style.display='none';
    photoFrame.style.display='block';
    setTimeout(()=>{ photoFrame.style.opacity='1'; },60);
    startPhotoCycle();
    setTimeout(()=> startTyping(), 400);
  },800);
}

/* Photo slideshow */
const photos=["1a.jpg","1b.jpg","1c.jpg","1d.jpg","1e.jpg","1f.jpg"];
let currentRound=[], roundIndex=0, cycleTimer=null;
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
let firstRoundDone=false;
function prepareRound(){ if(!firstRoundDone){ const rest=photos.filter(p=>p!=="1b.jpg"); const shuffled=shuffle(rest); currentRound=['1b.jpg',...shuffled]; firstRoundDone=true; } else { currentRound=shuffle(photos.slice()); } roundIndex=0; }
function startPhotoCycle(){
  if(cycleTimer) clearInterval(cycleTimer);
  prepareRound();
  roundIndex=1;
  cycleTimer=setInterval(()=>{
    if(roundIndex>=currentRound.length){ prepareRound(); roundIndex=0; }
    crossfadeTo(currentRound[roundIndex]);
    roundIndex++;
  },2600);
}
function crossfadeTo(src){
  const newImg=document.createElement('img');
  newImg.src=src;
  newImg.className='active floaty';
  newImg.style.opacity='0';
  photoFrame.appendChild(newImg);
  requestAnimationFrame(()=> newImg.style.opacity='1');
  setTimeout(()=>{
    const imgs=photoFrame.querySelectorAll('img');
    if(imgs.length>1){ imgs[0].classList.remove('active'); setTimeout(()=>{ if(imgs[0]) imgs[0].remove(); },1200); }
  },60);
}

/* Typing effect */
const koreanText="예나야, 가족과 함께 따뜻하고 달콤한 생일 보내! 지금처럼 밝고 사랑스러운 예나로 남아줘.";
let typingSpeed=38;
function startTyping(){
  typingWrap.setAttribute('aria-hidden','false');
  typingWrap.innerHTML='';
  let i=0;
  const cursor=document.createElement('span');
  cursor.className='typing-cursor';
  typingWrap.appendChild(cursor);
  const textNode=document.createElement('span');
  typingWrap.insertBefore(textNode,cursor);
  function step(){
    if(i<koreanText.length){ textNode.textContent+=koreanText[i]; i++; setTimeout(step, typingSpeed); }
    else{ cursor.remove(); showScrollArrow(); }
  }
  step();
}

/* Scroll arrow */
function showScrollArrow(){
  scrollArrow.style.display='flex';
  setTimeout(()=> scrollArrow.classList.add('show'),60);
  scrollArrow.addEventListener('click', ()=>{
    document.querySelector('#videoSection').scrollIntoView({behavior:'smooth', block:'center'});
    // play video only after scroll click
    yenaVideo.play().catch(()=>{ document.body.addEventListener('click',()=>{yenaVideo.play().catch(()=>{});},{once:true}); });
  });
  scrollArrow.addEventListener('keydown', (e)=>{ if(e.code==='Enter'||e.code==='Space') scrollArrow.click(); });
}
</script>
